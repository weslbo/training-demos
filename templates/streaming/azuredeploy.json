{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "alias": {
            "type": "String",
            "metadata": {
                "description": "Specify your initials"
            }
        }
    },
    "functions": [],
    "variables": {
        "eventhub-namespace": "[concat('eventhub-ns-', parameters('alias'))]",
        "eventhub-name": "[concat('eventhub-', parameters('alias'))]",
        "streamanalytics-job-name": "[concat('asa-', parameters('alias'), '-streaming')]",
        "datalake-accountname": "[concat('dl', parameters('alias'), uniqueString(resourceGroup().id))]"
    },
    "resources": [
        {
            "type": "Microsoft.EventHub/namespaces",
            "apiVersion": "2018-01-01-preview",
            "name": "[variables('eventhub-namespace')]",
            "location": "[resourceGroup().location]",
            "sku": {
                "name": "Standard",
                "tier": "Standard",
                "capacity": 1
            },
            "properties": {
                "zoneRedundant": false,
                "isAutoInflateEnabled": false,
                "maximumThroughputUnits": 0,
                "kafkaEnabled": true
            }
        },
        {
            "type": "Microsoft.EventHub/namespaces/eventhubs",
            "apiVersion": "2017-04-01",
            "name": "[concat(variables('eventhub-namespace'), '/', variables('eventhub-name'))]",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[resourceId('Microsoft.EventHub/namespaces', variables('eventhub-namespace'))]"
            ],
            "properties": {
                "messageRetentionInDays": 7,
                "partitionCount": 4,
                "captureDescription": {
                    "enabled": true,
                    "skipEmptyArchives": true,
                    "encoding": "Avro",
                    "intervalInSeconds": 900,
                    "sizeLimitInBytes": 314572800,
                    "destination": {
                        "name": "EventHubArchive.AzureBlockBlob",
                        "properties": {
                            "storageAccountResourceId": "[resourceId('Microsoft.Storage/storageAccounts', variables('datalake-accountname'))]",
                            "blobContainer": "zone-raw",
                            "archiveNameFormat": "{Namespace}/{EventHub}/{PartitionId}/{Year}/{Month}/{Day}/{Hour}/{Minute}/{Second}"
                        }
                    }
                }
            }
        },
        {
            "type": "Microsoft.StreamAnalytics/StreamingJobs",
            "apiVersion": "2019-06-01",
            "name": "[variables('streamanalytics-job-name')]",
            "location": "[resourceGroup().location]",
            "properties": {
                "sku": {
                    "name": "standard"
                },
                "outputErrorPolicy": "stop",
                "eventsOutOfOrderPolicy": "adjust",
                "eventsOutOfOrderMaxDelayInSeconds": 0,
                "eventsLateArrivalMaxDelayInSeconds": 5,
                "dataLocale": "en-US",
                "transformation": {
                    "name": "Transformation",
                    "properties": {
                        "streamingUnits": 1,
                        "query": "SELECT\r\n    *\r\nINTO\r\n    [YourOutputAlias]\r\nFROM\r\n    [YourInputAlias]"
                    }
                }
            }
        }
    ],
    "outputs": {}
}